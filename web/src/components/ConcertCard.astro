---
import { sanitizeUrl } from '../utils/sanitize';

interface Props {
  title: string;
  date: string;          // e.g., "29 Nov"
  day: string;           // e.g., "Sa" (German) or "Sat" (English)
  time?: string;         // e.g., "20:00"
  venue: string;         // e.g., "ZAG Arena"
  url?: string;
  eventType?: string;    // e.g., "concert", "sport", "show"
  genre?: string;        // e.g., "Konzert", "Festival"
  description?: string;  // Short description/subtitle
  status?: string;       // e.g., "available", "sold_out"
}

const { title, date, day, time, venue, url, eventType, genre, description, status } = Astro.props;

// Sanitize URL to prevent javascript: injection (defense-in-depth)
const safeUrl = sanitizeUrl(url);

// Convert German day abbreviations to English
const dayMap: Record<string, string> = {
  'Mo': 'Mon', 'Di': 'Tue', 'Mi': 'Wed', 'Do': 'Thu',
  'Fr': 'Fri', 'Sa': 'Sat', 'So': 'Sun'
};
const dayDisplay = dayMap[day] || day;

// Parse date into components for consistent display
// Format: "30 Nov" or "13 Jan 2026"
const dateParts = date.split(' ');
const dayNum = dateParts[0];  // "30" or "13"
const month = dateParts[1];   // "Nov" or "Jan"
const year = dateParts[2];    // "2026" or undefined

// Determine what info tag to show (genre or event type)
const infoTag = genre || (eventType && eventType !== 'concert' ? eventType : null);

// Check if sold out
const isSoldOut = status === 'sold_out';
---

<a
  href={safeUrl}
  target="_blank"
  rel="noopener noreferrer"
  class="concert-card block py-3 -mx-2 px-2 rounded card-hover"
  data-umami-event="event-click"
  data-umami-event-title={title}
  data-umami-event-venue={venue}
  data-umami-event-type={eventType || 'concert'}
>
  <!-- Date column + content -->
  <div class="flex items-start gap-4">
    <!-- Date block - fixed width for consistent vertical alignment -->
    <div class="flex-shrink-0 w-16 text-center">
      <div class="font-display text-xs text-text-muted uppercase tracking-wide">{dayDisplay}</div>
      <div class="font-display text-base leading-tight">
        <span class="text-text-data tabular-nums">{dayNum}</span>
        <span class="text-text-muted">{month}</span>
      </div>
      {year && <div class="font-display text-xs text-text-muted opacity-70">{year}</div>}
    </div>

    <!-- Content -->
    <div class="flex-1 min-w-0">
      <div class="flex items-center gap-2">
        <h3 class="font-body text-base font-semibold text-text-primary truncate">
          {title}
        </h3>
        {isSoldOut && (
          <span class="font-display text-[10px] uppercase text-accent px-1.5 py-0.5 bg-accent-dim rounded">
            Sold Out
          </span>
        )}
      </div>
      <div class="mt-0.5 font-display text-xs text-text-muted">
        {infoTag && (
          <>
            <span class="text-text-secondary">{infoTag}</span>
            <span class="text-text-muted"> &middot; </span>
          </>
        )}
        {time && <span class="text-text-secondary tabular-nums">{time}</span>}
        {time && <span> @ </span>}
        {!time && <span>@ </span>}
        <span>{venue}</span>
      </div>
      {description && (
        <p class="mt-1 font-body text-xs text-text-muted line-clamp-1">
          {description}
        </p>
      )}
    </div>
  </div>
</a>

<style>
  .concert-card {
    position: relative;
  }

  .concert-card::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 2px;
    height: 0;
    background: theme('colors.accent.DEFAULT');
    transition: height 0.2s ease-out;
    border-radius: 1px;
  }

  .concert-card:hover::before {
    height: 60%;
  }

  .concert-card:hover h3 {
    color: theme('colors.accent.DEFAULT');
  }

  .concert-card h3 {
    transition: color 0.2s ease-out;
  }
</style>
