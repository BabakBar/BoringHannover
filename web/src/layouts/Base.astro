---
import '../styles/global.css';

interface Props {
  title?: string;
  description?: string;
  lang?: string;
  image?: string;
  imageWidth?: number;
  imageHeight?: number;
  imageAlt?: string;
}

const {
  title = 'boringhannover',
  description = 'What\'s happening in Hannover this week. Movies, concerts, events.',
  lang = 'en',
  image = '/brand/og-image-1200x630.png',
  imageWidth = 1200,
  imageHeight = 630,
  imageAlt = 'Boring Hannover weekly events illustration'
} = Astro.props;

const DEFAULT_UMAMI_WEBSITE_ID = '23cf1ce2-3635-4e97-aab9-6ccd0467f839';

// Default keeps analytics working on the main deploy, but forks can override (or remove) via env.
const umamiWebsiteId = import.meta.env.PUBLIC_UMAMI_WEBSITE_ID || DEFAULT_UMAMI_WEBSITE_ID;
const umamiSrc = import.meta.env.PUBLIC_UMAMI_SRC || 'https://umami.fabriktakt.com/script.js';

const normalizedLang = (lang || 'en').toLowerCase();

const appName = 'boringhannover';

const siteUrl = (() => {
  const raw = Astro.site ?? import.meta.env.PUBLIC_SITE_URL;
  if (!raw) return undefined;
  try {
    return raw instanceof URL ? raw : new URL(raw);
  } catch {
    return undefined;
  }
})();

const canonicalUrl = siteUrl ? new URL(Astro.url.pathname, siteUrl).toString() : undefined;
const ogImage = siteUrl ? new URL(image, siteUrl).toString() : image;

// Open Graph locale uses underscores (e.g. de_DE, en_US)
const ogLocale = (() => {
  if (normalizedLang.startsWith('de')) return 'de_DE';
  if (normalizedLang.startsWith('en')) return 'en_US';
  if (normalizedLang.includes('-')) return normalizedLang.replace('-', '_');
  return 'en_US';
})();
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />

    <!-- Favicons (Google Search + browsers) -->
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="icon" type="image/svg+xml" href="/favicon-h.svg" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png" />

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    {canonicalUrl && <meta property="og:url" content={canonicalUrl} />}
    <meta property="og:locale" content={ogLocale} />
    {ogImage && <meta property="og:image" content={ogImage} />}
    {ogImage && <meta property="og:image:width" content={imageWidth} />}
    {ogImage && <meta property="og:image:height" content={imageHeight} />}
    {ogImage && <meta property="og:image:alt" content={imageAlt} />}

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    {ogImage && <meta name="twitter:image" content={ogImage} />}

    {canonicalUrl && <link rel="canonical" href={canonicalUrl} />}

    <!-- Theme - dynamic based on preference -->
    <meta name="theme-color" id="theme-color" content="#fafaf9" />
    <meta name="color-scheme" content="light dark" />

    <!-- Mobile web app -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="application-name" content={appName} />
    <meta name="apple-mobile-web-app-title" content={appName} />

    <!-- Minimal PWA -->
    <link rel="manifest" href="/manifest.webmanifest" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link
      rel="apple-touch-startup-image"
      href="/brand/startup/apple-touch-startup-image-640x1136.png"
      media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)"
    />
    <link
      rel="apple-touch-startup-image"
      href="/brand/startup/apple-touch-startup-image-750x1334.png"
      media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)"
    />
    <link
      rel="apple-touch-startup-image"
      href="/brand/startup/apple-touch-startup-image-828x1792.png"
      media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)"
    />
    <link
      rel="apple-touch-startup-image"
      href="/brand/startup/apple-touch-startup-image-1125x2436.png"
      media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)"
    />
    <link
      rel="apple-touch-startup-image"
      href="/brand/startup/apple-touch-startup-image-1170x2532.png"
      media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)"
    />
    <link
      rel="apple-touch-startup-image"
      href="/brand/startup/apple-touch-startup-image-1242x2688.png"
      media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)"
    />
    <link
      rel="apple-touch-startup-image"
      href="/brand/startup/apple-touch-startup-image-1284x2778.png"
      media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)"
    />
    <link
      rel="apple-touch-startup-image"
      href="/brand/startup/apple-touch-startup-image-1536x2048.png"
      media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)"
    />
    <link
      rel="apple-touch-startup-image"
      href="/brand/startup/apple-touch-startup-image-1668x2224.png"
      media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2)"
    />
    <link
      rel="apple-touch-startup-image"
      href="/brand/startup/apple-touch-startup-image-1668x2388.png"
      media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)"
    />
    <link
      rel="apple-touch-startup-image"
      href="/brand/startup/apple-touch-startup-image-2048x2732.png"
      media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)"
    />

    <title>{title}</title>

    <!-- Theme initialization (prevents flash) -->
    <script is:inline>
      (function() {
        const saved = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const isDark = saved === 'dark' || (!saved && prefersDark);

        if (isDark) {
          document.documentElement.classList.add('dark');
          document.getElementById('theme-color')?.setAttribute('content', '#0a0a0a');
        }
      })();
    </script>

    <!-- Umami Analytics (optional; configured via PUBLIC_UMAMI_* env vars) -->
    {umamiWebsiteId && (
      <script
        defer
        src={umamiSrc}
        data-website-id={umamiWebsiteId}
        data-domains="boringhannover.de,www.boringhannover.de"
      ></script>
    )}
  </head>
  <body class="bg-bg-primary min-h-screen">
    <!-- Skip navigation link for keyboard users (A-2) -->
    <a
      href="#main-content"
      class="skip-link sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 focus:z-50 focus:bg-accent focus:text-white focus:px-4 focus:py-2 focus:rounded focus:outline-none"
    >
      Skip to main content
    </a>
    <div class="max-w-mobile mx-auto px-4 py-6">
      <main id="main-content">
        <slot />
      </main>
    </div>
  </body>
</html>
