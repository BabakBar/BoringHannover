---
import Base from '../layouts/Base.astro';
import Header from '../components/Header.astro';
import SectionHeader from '../components/SectionHeader.astro';
import DateHeader from '../components/DateHeader.astro';
import MovieCard from '../components/MovieCard.astro';
import EventDayGroup from '../components/EventDayGroup.astro';
import Footer from '../components/Footer.astro';

// Load event data (from web_events.json or fallback to mock)
import { loadEventData } from '../data/loader';
import { groupEventsByDate, sliceEventGroups } from '../utils/groupEvents';

const eventData = loadEventData();
const { meta, movies, concerts } = eventData;

// Group events by date for timeline display
const eventGroups = groupEventsByDate(concerts);

// Smart progressive disclosure: complete day groups up to ~15 events
const VISIBLE_TARGET = 15;
const { visible: visibleGroups, overflow: overflowGroups } = sliceEventGroups(eventGroups, VISIBLE_TARGET);
const hasOverflow = overflowGroups.length > 0;

// Calculate overflow event count for button text
const overflowEventCount = overflowGroups.reduce((sum, g) => sum + g.events.length, 0);
---

<Base title="boringhannover - What's on in Hannover">
  <Header week={meta.week} year={meta.year} />

  <!-- Movies Section -->
  <section class="mb-10">
    <SectionHeader title="Movies This Week" />

    {movies.map((dayGroup) => (
      <div>
        <DateHeader day={dayGroup.day} date={dayGroup.date} />
        {dayGroup.movies.map((movie) => (
          <MovieCard
            title={movie.title}
            year={movie.year}
            time={movie.time}
            duration={movie.duration}
            language={movie.language}
            subtitles={movie.subtitles}
            rating={movie.rating}
            genre={movie.genre}
            url={movie.url}
          />
        ))}
      </div>
    ))}

    {movies.length === 0 && (
      <p class="text-text-muted text-sm py-4">No OV movies this week.</p>
    )}
  </section>

  <!-- Events Section (Timeline) -->
  <section class="mb-10">
    <SectionHeader title="Events On The Radar" />

    <!-- Visible event groups -->
    <div id="events-visible" class="events-timeline">
      {visibleGroups.map((group) => (
        <EventDayGroup
          day={group.day}
          dayNum={group.dayNum}
          month={group.month}
          year={group.year}
          events={group.events}
        />
      ))}
    </div>

    <!-- Overflow event groups (hidden by default) -->
    {hasOverflow && (
      <div id="events-overflow" class="events-timeline events-overflow" aria-hidden="true">
        {overflowGroups.map((group, groupIndex) => (
          <div class="overflow-group" style={`--group-index: ${groupIndex}`}>
            <EventDayGroup
              day={group.day}
              dayNum={group.dayNum}
              month={group.month}
              year={group.year}
              events={group.events}
            />
          </div>
        ))}
      </div>
    )}

    <!-- Toggle button -->
    {hasOverflow && (
      <button
        id="radar-toggle"
        type="button"
        class="radar-toggle"
        aria-expanded="false"
        aria-controls="events-overflow"
      >
        <span class="toggle-dots" aria-hidden="true">■ ■ ■</span>
        <span class="toggle-text">+{overflowEventCount} MORE</span>
        <span class="toggle-dots" aria-hidden="true">■ ■ ■</span>
      </button>
    )}

    {concerts.length === 0 && (
      <p class="text-text-muted text-sm py-4">No upcoming events.</p>
    )}
  </section>

  <Footer updatedAt={meta.updatedAt} />

  <!-- Legal links (required by German law) -->
  <nav class="mt-5 font-display text-[10px] md:text-[8px] text-text-muted text-center" aria-label="Legal">
    <a href="/impressum/" class="inline-block py-2 hover:text-text-secondary transition-colors">Impressum</a>
    <span class="mx-2">&middot;</span>
    <a href="/datenschutz/" class="inline-block py-2 hover:text-text-secondary transition-colors">Datenschutz</a>
  </nav>
</Base>

<script>
  // Radar Toggle - Progressive Disclosure
  const toggle = document.getElementById('radar-toggle');
  const overflow = document.getElementById('events-overflow');
  const toggleText = toggle?.querySelector('.toggle-text');

  if (toggle && overflow && toggleText) {
    const originalText = toggleText.textContent;
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    toggle.addEventListener('click', () => {
      const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
      isExpanded ? collapse() : expand();
    });

    function expand() {
      toggle.setAttribute('aria-expanded', 'true');
      overflow.setAttribute('aria-hidden', 'false');
      overflow.classList.add('is-visible');

      if (prefersReducedMotion) {
        overflow.classList.add('is-expanded');
      } else {
        void overflow.offsetHeight;
        overflow.classList.add('is-expanded');
      }

      toggleText.textContent = 'SHOW LESS';
    }

    function collapse() {
      toggle.setAttribute('aria-expanded', 'false');
      overflow.setAttribute('aria-hidden', 'true');
      toggleText.textContent = originalText;

      if (prefersReducedMotion) {
        overflow.classList.remove('is-expanded', 'is-visible');
        scrollToToggle();
      } else {
        overflow.classList.add('is-collapsing');
        overflow.classList.remove('is-expanded');

        overflow.addEventListener('animationend', function handler() {
          overflow.removeEventListener('animationend', handler);
          overflow.classList.remove('is-collapsing', 'is-visible');
          scrollToToggle();
        }, { once: true });
      }
    }

    function scrollToToggle() {
      const toggleRect = toggle.getBoundingClientRect();
      const viewportHeight = window.innerHeight;

      if (toggleRect.top < 0 || toggleRect.bottom > viewportHeight) {
        toggle.scrollIntoView({ behavior: prefersReducedMotion ? 'auto' : 'smooth', block: 'center' });
      }
    }
  }
</script>
